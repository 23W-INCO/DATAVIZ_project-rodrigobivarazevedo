<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4">Blood Tests Visualization App</h1>

    <div class="row">
        <!-- First Card -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Patient Information
                </div>
                <div class="card-body">
                    <div id="patientInfo"></div>
                    
                    <!-- Add padding to the top of the form -->
                    <form id="patientInfoForm" onsubmit="searchPatient(); return false;" method="post" style="padding-top: 20px;">
                        <!-- Prevents default form submission -->
                        <div class="form-group">
                            <label for="patientIDPatientInfo">Patient ID</label>
                            <input type="text" class="form-control" id="patientIDPatientInfo" name="patientIDPatientInfo" placeholder="Enter patient ID">
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Search</button>
                    </form>
                </div>
            </div>
        </div>


        
         <!-- Second Card -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    Blood Tests Information
                </div>
                <div class="card-body">
                    <form id="searchForm" onsubmit="searchBloodTests(); return false;">
                        <!-- Prevents default form submission -->
                        <div class="form-group">
                            <label for="patientID">Patient ID</label>
                            <input type="text" class="form-control" id="patientID" name="patientID"
                                placeholder="Enter patient ID">
                        </div>
                        <div class="form-group">
                            <label for="date">Effective Date</label>
                            <input type="date" class="form-control" id="date" name="date">
                        </div>
                        <div>
                            <label for="blood_test_dates">Blood Tests Dates</label>
                            <ul></ul>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Search</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Create a div where the graph will take place -->
<div id="heatmap"></div>

<script>

    let input = document.getElementById('patientID');
    input.addEventListener('input', async function () {
        let response = await fetch('/dates?q=' + input.value);
        let dates = await response.json();
        let html = '';
        for (let date of dates) {
            html += '<li>' + date.DATE + '</li>';
        }
        document.querySelector('ul').innerHTML = html;
    });




    function searchPatient() {
        // Get values from form inputs
        var patientID = document.getElementById('patientIDPatientInfo').value;
    
        // Use JavaScript to fetch data from the Flask route
        const url = `/${patientID}/raw`;
    
        fetch(url, {
            method: 'POST', // Use POST method
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
    
                // Check if data is not an empty list
                if (data.length > 0) {
                    const patientInfo = data[0]; // Assuming there's only one element in the list

                    // Construct HTML to display patient information
                    const patientInfoHtml = `
                        <p><strong>Patient ID:</strong> ${patientInfo.ID}</p>
                        <p><strong>First Name:</strong> ${patientInfo.FIRST_NAME}</p>
                        <p><strong>Last Name:</strong> ${patientInfo.LAST_NAME}</p>
                        <p><strong>Birth Date:</strong> ${patientInfo.BIRTH_DATE}</p>
                        <p><strong>Gender:</strong> ${patientInfo.GENDER}</p>
                    `;
    
                    // Display patient information in the HTML
                    document.getElementById('patientInfo').innerHTML = patientInfoHtml;
                } else {
                    // Handle the case where the data list is empty
                    console.error('Empty response data.');
                }
            })
            .catch(error => {
                console.error('Error fetching patient data:', error);
                // Add error handling here, e.g., display an error message to the user
            });
    }
    
    
    function searchBloodTests() {

        // Remove existing SVG element
        d3.select('#heatmap').selectAll('*').remove();

        // Get values from form inputs
        var blood_test_patientID = document.getElementById('patientID').value;
        var effectiveDate = document.getElementById('date').value;
        var maxQuantity = document.getElementById('Quantity').value;
    
        // Use JavaScript to fetch data from the Flask route
        const url = `/blood_tests/raw/?ID=${blood_test_patientID}?date=${effectiveDate}`;
    
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
    
                // Convert data to suitable format
                const dataArray = [];
                const dict = data[0]; // Assuming there's only one dictionary in the list
                for (const key in dict) {
                    const [value, color] = dict[key];
                    dataArray.push({ value, color, key });
                }
    
                // Define margin and cell size
                const margin = { top: 20, right: 250, bottom: 20, left: 260 };
                const cellSize = 30;
                const cellWidth = 200;
                const cellHeight = 30;
    
                // Create SVG element
                const svg = d3.select('#heatmap').append('svg')
                    .attr('width', 800)
                    .attr('height', dataArray.length * cellHeight + margin.top + margin.bottom)
                    .style('margin', margin.top + 'px ' + margin.right + 'px ' + margin.bottom + 'px ' + margin.left + 'px');
        
                // Define color scale based on color strings
                const colorScale = d3.scaleOrdinal()
                    .domain(['green', 'yellow', 'red'])
                    .range(['green', '#ffd800', '#c80815']);
            
                // Draw cells
                svg.selectAll('rect')
                    .data(dataArray)
                    .enter().append('rect')
                    .attr('x', margin.left)
                    .attr('y', (d, i) => margin.top + i * cellHeight)
                    .attr('width', cellWidth)
                    .attr('height', cellHeight)
                    .style('fill', d => colorScale(d.color))
                    .on('mouseover', function (event, d) {
                        // Display blood level on mouse hover
                        d3.select(this).append('title').text(`Blood Level: ${d.value}`);
                    });
            
                // Add y-axis labels with word wrapping
                svg.selectAll('text')
                    .data(dataArray)
                    .enter().append('text')
                    .attr('x', margin.left - 10)
                    .attr('y', (d, i) => margin.top + i * cellHeight + cellHeight / 2)
                    .attr('dy', '0.35em')
                    .style('text-anchor', 'end')
                    .style('alignment-baseline', 'middle')
                    .style('fill', 'black')
                    .text(function (d) {
                        // Split and wrap text to fit in the available space
                        const words = d.key.split(/\s+/);
                        let line = '';
                        const lines = [];
                        const lineHeight = 1.1; // ems
            
                        for (const word of words) {
                            const testLine = line.length === 0 ? word : `${line} ${word}`;
                            const metrics = this.getComputedTextLength();
                            if (metrics > margin.left - 10 && line.length > 0) {
                                lines.push(line);
                                line = word;
                            } else {
                                line = testLine;
                            }
                        }
            
                        lines.push(line);
                        return lines.join('\n');
                    });
        
                // Draw black lines between cells
                svg.selectAll('line')
                    .data(dataArray)
                    .enter().append('line')
                    .attr('x1', margin.left)
                    .attr('x2', margin.left + cellWidth)
                    .attr('y1', (d, i) => margin.top + (i + 1) * cellHeight)
                    .attr('y2', (d, i) => margin.top + (i + 1) * cellHeight)
                    .style('stroke', 'black');
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            // Add error handling here, e.g., display an error message to the user
        });
}

    

</script>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>